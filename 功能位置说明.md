# 功能位置详细说明

## 一、点名功能（管理员）

### 位置：管理面板 → 点名管理

1. **登录管理员账号**
2. **点击顶部导航栏的"管理面板"**
3. **在管理面板页面，点击"点名管理"标签**（如果看不到，可能在页面顶部的标签栏中）
4. 在点名列表中，每个点名任务卡片都有两个绿色/紫色按钮：

   - **绿色"立即点名"按钮**：点击后立即触发点名，马上发送邮件
   - **紫色"定时点名"按钮**：点击后弹出时间选择框，设置触发时间

### 立即点名步骤：
1. 找到任意一个点名任务
2. 点击绿色的"⚡ 立即点名"按钮
3. 弹出确认框，点击"确定"
4. 看到提示"点名已立即触发，邮件通知已发送！"
5. 查看后台日志，应该看到邮件发送成功的消息

### 定时点名步骤：
1. 找到任意一个点名任务
2. 点击紫色的"🕐 定时点名"按钮
3. 在弹出的对话框中，选择一个时间（例如：当前时间+2分钟）
4. 点击"确认设置"
5. 看到提示"点名已设置在 HH:MM 触发！"
6. 等待到达设置的时间，系统会自动发送邮件

---

## 二、异议申请功能（普通用户）

### 位置：积分看板 → 个人积分历史

1. **登录普通用户账号**（不是管理员）
2. **点击顶部导航栏的"积分看板"**（第一个菜单项）
3. **在积分看板页面，找到自己的姓名行**
4. **点击自己的积分数字**（例如点击"100"）
5. 弹出"积分历史记录"窗口
6. **在窗口底部有橙色的"提交异议"按钮**
7. 点击后填写：
   - 申请调整积分（例如：10 或 -5）
   - 异议理由
8. 点击"提交异议"
9. 提交后，**所有管理员会收到邮件通知**

---

## 三、异议处理功能（管理员）

### 位置：管理面板 → 异议管理

1. **登录管理员账号**
2. **点击顶部导航栏的"管理面板"**
3. **在管理面板页面，点击"异议管理"标签**
4. 看到待处理的异议列表
5. 点击"批准"或"拒绝"按钮
6. 填写管理员备注（可选）
7. 确认后，**申请人会收到邮件通知**

---

## 四、请假功能

### 用户提交请假（所有用户）
**位置：请假申请页面**
1. 点击顶部导航栏"请假申请"
2. 填写请假信息
3. 提交后，**所有管理员会收到邮件通知**

### 管理员审批（管理员）
**位置：请假审批页面**
1. 点击顶部导航栏"请假审批"
2. 查看待审批的请假申请
3. 点击"批准"或"驳回"
4. 审批后，**申请人会收到邮件通知**

---

## 五、测试邮件发送

### 测试步骤：

1. **确保后端服务已重启**（重要！）
   ```bash
   # 如果用PM2
   pm2 restart all
   
   # 或者停止当前服务，重新启动
   npm run dev  # 或 npm start
   ```

2. **查看后台日志**
   - 启动时应该看到：`Attendance scheduler started`
   - 每分钟会看到：`[Scheduler] Checking notifications at ...`

3. **测试异议申请邮件**：
   - 用户：提交异议 → 管理员收邮件
   - 管理员：处理异议 → 用户收邮件

4. **测试立即点名邮件**：
   - 管理员：点击"立即点名" → 目标用户立即收邮件
   - 后台日志应显示：`✅ Email sent successfully to ...`

5. **测试定时点名邮件**：
   - 管理员：设置2分钟后的时间
   - 等待2-3分钟
   - 目标用户应收到邮件
   - 后台日志应显示：`[Scheduler] Found 1 trigger(s) to notify`

---

## 六、如果邮件还是没发送

### 检查清单：

1. ✅ **环境变量是否正确**
   ```bash
   cd backend
   cat .env
   # 确认有这些配置：
   # EMAIL_USER=roboticlab@qq.com
   # EMAIL_PASS=ghujiouvebmdcieh
   ```

2. ✅ **后端是否重启**
   - 修改代码后必须重启服务
   - 查看启动日志是否有错误

3. ✅ **查看详细日志**
   - 后台应该显示：`Attempting to send email to ...`
   - 如果显示：`Email config - USER: NOT SET` → 环境变量没加载
   - 如果显示：`❌ Email sending failed` → 查看具体错误信息

4. ✅ **测试邮件配置**
   ```bash
   cd backend
   node test-email.js
   ```
   应该显示：`✅ 测试邮件发送成功！`

---

## 七、常见问题

### Q: 我看不到"立即点名"和"定时点名"按钮
**A:** 
- 确保前端已重新编译：`cd frontend && npm run build`
- 刷新浏览器页面（Ctrl+F5 强制刷新）
- 确保以管理员身份登录

### Q: 点击立即点名没反应
**A:**
- 查看浏览器控制台（F12）是否有错误
- 查看后台日志是否有请求
- 确保今天还没有触发过该点名任务

### Q: 定时点名设置后没发送邮件
**A:**
- 确认后台定时任务正在运行（日志中每分钟应有 `[Scheduler] Checking...`）
- 等待时间要超过设置的时间1-2分钟（定时任务每分钟检查一次）
- 查看后台日志是否有触发和发送记录

### Q: 异议申请找不到入口
**A:**
1. 登录普通用户（不是管理员）
2. 进入"积分看板"页面
3. 点击自己姓名行的积分数字
4. 在弹出的积分历史窗口中，底部有"提交异议"按钮

---

## 八、截图说明位置

由于无法直接提供截图，这里用文字详细描述：

### 点名管理界面布局：
```
┌─────────────────────────────────────┐
│     [+ 创建点名任务]                │
├─────────────────────────────────────┤
│  ┌───────────────────────────────┐  │
│  │ 点名任务1                     │  │
│  │ 描述...                       │  │
│  │ 📅 开始：2024-01-01           │  │
│  │ 🕐 截止：2024-01-31           │  │
│  │ 📍 地点名称 (200米)           │  │
│  │ 👥 已触发：5 次               │  │
│  │ 扣分：5 分                    │  │
│  │                               │  │
│  │ [⚡ 立即点名] [🕐 定时点名]   │  │  ← 这里！
│  │ [✏️ 编辑] [🗑️ 删除]          │  │
│  └───────────────────────────────┘  │
└─────────────────────────────────────┘
```

### 积分看板界面布局：
```
┌─────────────────────────────────────┐
│  排名  姓名  学号    积分            │
├─────────────────────────────────────┤
│  1    张三  001    150  ← 点这个数字 │
│  2    李四  002    120              │
│  3    你    003    100  ← 或这个     │
└─────────────────────────────────────┘

点击后弹出：
┌─────────────────────────────┐
│  积分历史记录               │
├─────────────────────────────┤
│  +10  完成实验  2024-01-01  │
│  -5   迟到      2024-01-02  │
│  ...                        │
├─────────────────────────────┤
│  [⚠️ 提交异议]  [关闭]      │  ← 这里！
└─────────────────────────────┘
```

