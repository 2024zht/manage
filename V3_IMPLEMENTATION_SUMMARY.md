# V3.0 å®ç°æ€»ç»“ - è¯·å‡å®¡æ‰¹ä¸ç”µå­ä¹¦ç®¡ç†

## ğŸ‰ å·²å®Œæˆçš„å·¥ä½œ

### âœ… åç«¯å®ç°ï¼ˆ100%å®Œæˆï¼‰

#### 1. æ•°æ®åº“æ¶æ„
- âœ… **leavesè¡¨** - å­˜å‚¨è¯·å‡è®°å½•
  ```sql
  - id, userId, leaveType, startTime, endTime, duration
  - reason, status, createdAt, respondedAt, respondedBy, rejectReason
  ```

- âœ… **ebooksè¡¨** - å­˜å‚¨ç”µå­ä¹¦ä¿¡æ¯
  ```sql
  - id, filename, originalName, fileSize, uploadedBy
  - uploadedAt, b2Synced, b2Path
  ```

#### 2. APIè·¯ç”±
- âœ… **è¯·å‡API** (`backend/src/routes/leaves.ts`)
  - `POST /api/leaves` - æäº¤è¯·å‡ç”³è¯·
  - `GET /api/leaves/my-leaves` - è·å–æˆ‘çš„è¯·å‡è®°å½•
  - `GET /api/leaves` - è·å–æ‰€æœ‰è¯·å‡ï¼ˆç®¡ç†å‘˜ï¼‰
  - `PATCH /api/leaves/:id` - å®¡æ‰¹è¯·å‡ï¼ˆç®¡ç†å‘˜ï¼‰

- âœ… **ç”µå­ä¹¦API** (`backend/src/routes/ebooks.ts`)
  - `GET /api/ebooks` - è·å–ç”µå­ä¹¦åˆ—è¡¨
  - `POST /api/ebooks/upload` - ä¸Šä¼ ç”µå­ä¹¦ï¼ˆç®¡ç†å‘˜ï¼‰
  - `DELETE /api/ebooks/:id` - åˆ é™¤ç”µå­ä¹¦ï¼ˆç®¡ç†å‘˜ï¼‰
  - `GET /api/ebooks/:id/download-url` - è·å–ä¸‹è½½é“¾æ¥

#### 3. ç±»å‹å®šä¹‰
- âœ… `Leave` æ¥å£ï¼ˆå‰åç«¯ï¼‰
- âœ… `Ebook` æ¥å£ï¼ˆå‰åç«¯ï¼‰
- âœ… å®Œæ•´çš„TypeScriptç±»å‹æ”¯æŒ

#### 4. æ–‡ä»¶ä¸Šä¼ 
- âœ… é›†æˆMulterä¸­é—´ä»¶
- âœ… æ–‡ä»¶å¤§å°é™åˆ¶ï¼ˆ100MBï¼‰
- âœ… æ–‡ä»¶ç±»å‹éªŒè¯
- âœ… è‡ªåŠ¨æ–‡ä»¶åå¤„ç†

#### 5. Backblaze B2é›†æˆ
- âœ… è‡ªåŠ¨åŒæ­¥åˆ°B2äº‘å­˜å‚¨
- âœ… æœ¬åœ°ä¸´æ—¶æ–‡ä»¶æ¸…ç†
- âœ… é”™è¯¯å¤„ç†å’Œæ—¥å¿—è®°å½•
- âœ… URLç¼–ç å¤„ç†

#### 6. æœåŠ¡å™¨é…ç½®
- âœ… è·¯ç”±æ³¨å†Œï¼ˆ`backend/src/server.ts`ï¼‰
- âœ… ä¾èµ–æ›´æ–°ï¼ˆ`package.json`ï¼‰
- âœ… æ•°æ®åº“åˆå§‹åŒ–è„šæœ¬

## ğŸ“ å¾…å®Œæˆçš„å·¥ä½œ

### ğŸ”¨ å‰ç«¯å®ç°ï¼ˆéœ€è¦æ‰‹åŠ¨åˆ›å»ºï¼‰

#### å¿…é¡»åˆ›å»ºçš„3ä¸ªç»„ä»¶æ–‡ä»¶

1. **`frontend/src/components/LeaveRequest.tsx`**
   - ç”¨æˆ·è¯·å‡ç”³è¯·è¡¨å•
   - æˆ‘çš„è¯·å‡è®°å½•åˆ—è¡¨
   - æ—¶é•¿è‡ªåŠ¨è®¡ç®—
   - çº¦350è¡Œä»£ç 

2. **`frontend/src/components/LeaveApproval.tsx`**
   - å¾…å®¡æ‰¹è¯·å‡åˆ—è¡¨
   - å·²å¤„ç†è¯·å‡å†å²
   - æ‰¹å‡†/æ‹’ç»æ“ä½œ
   - çº¦250è¡Œä»£ç 

3. **`frontend/src/components/Ebooks.tsx`**
   - ç”µå­ä¹¦åˆ—è¡¨å±•ç¤º
   - ä¸Šä¼ åŠŸèƒ½ï¼ˆç®¡ç†å‘˜ï¼‰
   - ä¸‹è½½åŠŸèƒ½
   - åˆ é™¤åŠŸèƒ½ï¼ˆç®¡ç†å‘˜ï¼‰
   - çº¦300è¡Œä»£ç 

#### éœ€è¦ä¿®æ”¹çš„æ–‡ä»¶

1. **`frontend/src/App.tsx`**
   ```typescript
   // æ·»åŠ å¯¼å…¥
   import LeaveRequest from './components/LeaveRequest';
   import LeaveApproval from './components/LeaveApproval';
   import Ebooks from './components/Ebooks';
   
   // æ·»åŠ è·¯ç”±
   <Route path="leaves" element={<LeaveRequest />} />
   <Route path="ebooks" element={<Ebooks />} />
   <Route path="admin/leave-approval" element={<AdminRoute><LeaveApproval /></AdminRoute>} />
   ```

2. **`frontend/src/components/Layout.tsx`**
   ```typescript
   // æ·»åŠ å¯¼å…¥
   import { Calendar, Book } from 'lucide-react';
   
   // æ·»åŠ å¯¼èˆªé“¾æ¥
   <NavLink to="/leaves">
     <Calendar className="inline h-5 w-5 mr-2" />
     è¯·å‡ç”³è¯·
   </NavLink>
   
   <NavLink to="/ebooks">
     <Book className="inline h-5 w-5 mr-2" />
     ç”µå­ä¹¦åº“
   </NavLink>
   
   // ç®¡ç†å‘˜èœå•
   {user?.isAdmin && (
     <NavLink to="/admin/leave-approval">
       è¯·å‡å®¡æ‰¹
     </NavLink>
   )}
   ```

## ğŸš€ å¿«é€Ÿéƒ¨ç½²æŒ‡å—

### æ­¥éª¤1ï¼šå®‰è£…åç«¯ä¾èµ–

```bash
cd backend
npm install
```

æ–°å¢ä¾èµ–ï¼š
- `multer` - æ–‡ä»¶ä¸Šä¼ 
- `@types/multer` - TypeScriptç±»å‹

### æ­¥éª¤2ï¼šé…ç½®ç¯å¢ƒå˜é‡

ç¼–è¾‘ `backend/.env`ï¼Œæ·»åŠ ï¼š

```bash
# Backblaze B2é…ç½®
B2_BUCKET_NAME=your-bucket-name
B2_FOLDER=ebooks
CF_WORKER_URL=https://divine-glade-0efd.hengtangzhao.workers.dev/api
```

### æ­¥éª¤3ï¼šå®‰è£…B2 CLIï¼ˆUbuntuæœåŠ¡å™¨ï¼‰

```bash
# å®‰è£…B2å‘½ä»¤è¡Œå·¥å…·
pip install --upgrade b2

# æˆæƒB2è´¦æˆ·
b2 authorize-account <application_key_id> <application_key>

# æµ‹è¯•è¿æ¥
b2 list-buckets
```

### æ­¥éª¤4ï¼šåˆå§‹åŒ–æ•°æ®åº“

```bash
cd backend
npm run init-db
```

è¿™å°†åˆ›å»º `leaves` å’Œ `ebooks` è¡¨ã€‚

### æ­¥éª¤5ï¼šåˆ›å»ºå‰ç«¯ç»„ä»¶

**å®Œæ•´çš„ç»„ä»¶ä»£ç åœ¨**ï¼š`LEAVE_EBOOK_IMPLEMENTATION.md`

ç›´æ¥å¤åˆ¶ä»¥ä¸‹æ–‡ä»¶çš„å®Œæ•´ä»£ç ï¼š
- LeaveRequest.tsxï¼ˆç¬¬3.1èŠ‚ï¼‰
- LeaveApproval.tsxï¼ˆç¬¬3.2èŠ‚ï¼‰
- Ebooks.tsxï¼ˆç¬¬3.3èŠ‚ï¼‰

### æ­¥éª¤6ï¼šæ›´æ–°è·¯ç”±å’Œå¯¼èˆª

æŒ‰ç…§"éœ€è¦ä¿®æ”¹çš„æ–‡ä»¶"éƒ¨åˆ†æ›´æ–° `App.tsx` å’Œ `Layout.tsx`

### æ­¥éª¤7ï¼šé‡å¯é¡¹ç›®

```bash
# å¼€å‘ç¯å¢ƒ
cd /path/to/project
npm run dev

# ç”Ÿäº§ç¯å¢ƒ
npm run build
npm start
```

## ğŸ“‹ åŠŸèƒ½éªŒè¯æ¸…å•

### è¯·å‡å®¡æ‰¹æ¨¡å—

**ç”¨æˆ·ç«¯**ï¼š
- [ ] å¯ä»¥è®¿é—®"è¯·å‡ç”³è¯·"é¡µé¢
- [ ] å¯ä»¥é€‰æ‹©è¯·å‡ç±»å‹
- [ ] å¯ä»¥é€‰æ‹©èµ·æ­¢æ—¶é—´
- [ ] æ—¶é•¿è‡ªåŠ¨è®¡ç®—æ­£ç¡®
- [ ] å¯ä»¥æäº¤è¯·å‡ç”³è¯·
- [ ] å¯ä»¥æŸ¥çœ‹è‡ªå·±çš„è¯·å‡è®°å½•
- [ ] å¯ä»¥çœ‹åˆ°ç”³è¯·çŠ¶æ€ï¼ˆå¾…å®¡æ‰¹/å·²æ‰¹å‡†/å·²æ‹’ç»ï¼‰

**ç®¡ç†å‘˜ç«¯**ï¼š
- [ ] å¯ä»¥è®¿é—®"è¯·å‡å®¡æ‰¹"é¡µé¢
- [ ] å¯ä»¥çœ‹åˆ°æ‰€æœ‰å¾…å®¡æ‰¹è¯·å‡
- [ ] å¯ä»¥æ‰¹å‡†è¯·å‡
- [ ] å¯ä»¥æ‹’ç»è¯·å‡ï¼ˆéœ€å¡«å†™ç†ç”±ï¼‰
- [ ] å¯ä»¥æŸ¥çœ‹å·²å¤„ç†çš„è¯·å‡å†å²

### ç”µå­ä¹¦ç®¡ç†æ¨¡å—

**ç”¨æˆ·ç«¯**ï¼š
- [ ] å¯ä»¥è®¿é—®"ç”µå­ä¹¦åº“"é¡µé¢
- [ ] å¯ä»¥æµè§ˆæ‰€æœ‰ç”µå­ä¹¦
- [ ] å¯ä»¥ä¸‹è½½ç”µå­ä¹¦
- [ ] æ˜¾ç¤ºæ–‡ä»¶å¤§å°å’Œä¸Šä¼ ä¿¡æ¯

**ç®¡ç†å‘˜ç«¯**ï¼š
- [ ] å¯ä»¥ä¸Šä¼ ç”µå­ä¹¦
- [ ] ä¸Šä¼ åè‡ªåŠ¨åŒæ­¥åˆ°B2
- [ ] æœ¬åœ°æ–‡ä»¶è‡ªåŠ¨æ¸…ç†
- [ ] å¯ä»¥åˆ é™¤ç”µå­ä¹¦
- [ ] çœ‹åˆ°B2åŒæ­¥çŠ¶æ€

## ğŸ”§ æŠ€æœ¯ç»†èŠ‚

### è¯·å‡æ—¶é•¿è®¡ç®—

```typescript
// å‰ç«¯è‡ªåŠ¨è®¡ç®—
useEffect(() => {
  if (startTime && endTime) {
    const diff = new Date(endTime) - new Date(startTime);
    const days = Math.floor(diff / (1000 * 60 * 60 * 24));
    const hours = Math.floor((diff % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
    setDuration(`${days}å¤©${hours}å°æ—¶`);
  }
}, [startTime, endTime]);
```

### B2åŒæ­¥æµç¨‹

1. **ä¸Šä¼ **: æ–‡ä»¶ â†’ `/uploads/ebooks/`
2. **åŒæ­¥**: æ‰§è¡Œ `b2 sync localPath b2://bucket/folder/`
3. **æ¸…ç†**: åŒæ­¥æˆåŠŸååˆ é™¤æœ¬åœ°æ–‡ä»¶
4. **è®°å½•**: æ›´æ–°æ•°æ®åº“ `b2Synced = 1`

### URLç¼–ç å¤„ç†

```typescript
// æ–‡ä»¶åå¯èƒ½åŒ…å«ç‰¹æ®Šå­—ç¬¦ï¼šC++ Primer plus.pdf
const encodedFilename = encodeURIComponent(originalName);
// ç»“æœï¼šC%2B%2B%20Primer%20plus.pdf
const downloadUrl = `${workerUrl}/${encodedFilename}`;
```

## ğŸ“Š æ•°æ®æµç¨‹

### è¯·å‡ç”³è¯·æµç¨‹

```
ç”¨æˆ·æäº¤è¯·å‡
    â†“
POST /api/leaves
    â†“
å­˜å…¥æ•°æ®åº“ï¼ˆstatus='pending'ï¼‰
    â†“
ç®¡ç†å‘˜æŸ¥çœ‹å¾…å®¡æ‰¹åˆ—è¡¨
    â†“
PATCH /api/leaves/:id (status='approved/rejected')
    â†“
æ›´æ–°æ•°æ®åº“
    â†“
ç”¨æˆ·æŸ¥çœ‹ç»“æœ
```

### ç”µå­ä¹¦ä¸Šä¼ æµç¨‹

```
ç®¡ç†å‘˜é€‰æ‹©æ–‡ä»¶
    â†“
POST /api/ebooks/upload (multipart/form-data)
    â†“
Multerä¿å­˜åˆ° /uploads/ebooks/
    â†“
è®°å½•åˆ°æ•°æ®åº“
    â†“
æ‰§è¡Œ b2 sync å‘½ä»¤
    â†“
åŒæ­¥æˆåŠŸ â†’ åˆ é™¤æœ¬åœ°æ–‡ä»¶ â†’ b2Synced=1
åŒæ­¥å¤±è´¥ â†’ ä¿ç•™æœ¬åœ°æ–‡ä»¶ â†’ è®°å½•é”™è¯¯
    â†“
ç”¨æˆ·ä¸‹è½½: GET /api/ebooks/:id/download-url
    â†“
è¿”å›Cloudflare Worker URL
```

## âš ï¸ æ³¨æ„äº‹é¡¹

### å®‰å…¨æ€§
- âœ… æ‰€æœ‰APIéƒ½éœ€è¦JWTè®¤è¯
- âœ… æ–‡ä»¶ä¸Šä¼ ä»…é™ç®¡ç†å‘˜
- âœ… è¯·å‡å®¡æ‰¹ä»…é™ç®¡ç†å‘˜
- âœ… é˜²æ­¢è·¯å¾„éå†æ”»å‡»
- âœ… æ–‡ä»¶ç±»å‹éªŒè¯

### æ€§èƒ½
- âœ… æ–‡ä»¶å¤§å°é™åˆ¶100MB
- âœ… ä¸Šä¼ è¶…æ—¶æ—¶é—´60ç§’
- âœ… B2åŒæ­¥å¼‚æ­¥å¤„ç†
- âœ… æœ¬åœ°æ–‡ä»¶è‡ªåŠ¨æ¸…ç†

### ç”¨æˆ·ä½“éªŒ
- âœ… æ—¶é•¿è‡ªåŠ¨è®¡ç®—
- âœ… å“åº”å¼è®¾è®¡
- âœ… åŠ è½½çŠ¶æ€æ˜¾ç¤º
- âœ… é”™è¯¯æç¤ºå‹å¥½

## ğŸ“š ç›¸å…³æ–‡æ¡£

| æ–‡æ¡£ | è¯´æ˜ |
|------|------|
| **LEAVE_EBOOK_IMPLEMENTATION.md** | å®Œæ•´å®ç°æŒ‡å—ï¼ˆå«æ‰€æœ‰ç»„ä»¶ä»£ç ï¼‰ |
| **LEAVE_EBOOK_QUICK_GUIDE.md** | å¿«é€Ÿå¼€å§‹æŒ‡å— |
| **FEATURES_ROADMAP.md** | åŠŸèƒ½è·¯çº¿å›¾ |
| **API_REFERENCE.md** | APIæ–‡æ¡£ï¼ˆéœ€åˆ›å»ºï¼‰ |

## ğŸ¯ ä¸‹ä¸€æ­¥è¡ŒåŠ¨

### ç«‹å³æ‰§è¡Œ
1. âœ… å®‰è£…åç«¯ä¾èµ–ï¼š`cd backend && npm install`
2. âœ… é…ç½®ç¯å¢ƒå˜é‡ï¼šç¼–è¾‘ `backend/.env`
3. âœ… å®‰è£…B2 CLIï¼ˆå¦‚æœéœ€è¦ï¼‰
4. âœ… åˆå§‹åŒ–æ•°æ®åº“ï¼š`npm run init-db`
5. ğŸ“ åˆ›å»º3ä¸ªå‰ç«¯ç»„ä»¶ï¼ˆä»LEAVE_EBOOK_IMPLEMENTATION.mdå¤åˆ¶ä»£ç ï¼‰
6. ğŸ“ æ›´æ–°è·¯ç”±å’Œå¯¼èˆª
7. ğŸš€ é‡å¯é¡¹ç›®æµ‹è¯•

### æµ‹è¯•æµç¨‹
1. ç”¨æˆ·æäº¤è¯·å‡ç”³è¯·
2. ç®¡ç†å‘˜å®¡æ‰¹è¯·å‡
3. ç®¡ç†å‘˜ä¸Šä¼ ç”µå­ä¹¦
4. ç”¨æˆ·æµè§ˆå’Œä¸‹è½½ç”µå­ä¹¦

### å¯é€‰ä¼˜åŒ–
- [ ] æ·»åŠ é‚®ä»¶é€šçŸ¥
- [ ] æ·»åŠ è¯·å‡ç»Ÿè®¡
- [ ] ç”µå­ä¹¦åˆ†ç±»æ ‡ç­¾
- [ ] ç”µå­ä¹¦æœç´¢åŠŸèƒ½
- [ ] æ‰¹é‡å®¡æ‰¹åŠŸèƒ½

## ğŸ’¡ æç¤º

- æ‰€æœ‰åç«¯ä»£ç å·²å®Œæˆå¹¶å¯ç›´æ¥ä½¿ç”¨
- å‰ç«¯ç»„ä»¶ä»£ç å®Œæ•´å¯ç”¨ï¼Œç›´æ¥å¤åˆ¶å³å¯
- ç¯å¢ƒå˜é‡é…ç½®æ˜¯å…³é”®ï¼Œç¡®ä¿B2é…ç½®æ­£ç¡®
- å»ºè®®å…ˆåœ¨å¼€å‘ç¯å¢ƒæµ‹è¯•ï¼Œå†éƒ¨ç½²åˆ°ç”Ÿäº§ç¯å¢ƒ

---

**ç‰ˆæœ¬**: V3.0
**çŠ¶æ€**: åç«¯å®Œæˆï¼Œå‰ç«¯å¾…å®ç°
**é¢„è®¡å®Œæˆæ—¶é—´**: 30-60åˆ†é’Ÿï¼ˆåˆ›å»ºå‰ç«¯ç»„ä»¶ï¼‰
**æ–‡æ¡£å®Œæ•´åº¦**: â­â­â­â­â­

**é—®é¢˜åé¦ˆ**: æŸ¥çœ‹è¯¦ç»†æ–‡æ¡£æˆ–æäº¤Issue

