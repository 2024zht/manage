# 邮件和点名功能修复说明

## 已修复的功能

### 1. 邮件发送功能
- ✅ 请假申请：用户提交请假时，自动发邮件给所有管理员
- ✅ 请假审批：管理员审批后，自动发邮件给申请人
- ✅ 积分异议：管理员处理异议后，自动发邮件给申请人
- ✅ 点名通知：点名触发时，自动发邮件给目标用户

### 2. 点名触发方式

#### 方式一：立即点名
- 点击"立即点名"按钮
- 立即创建触发记录并发送邮件通知
- 1分钟后自动截止并扣分

#### 方式二：定时点名
- 点击"定时点名"按钮
- 设置触发时间（例如：21:15）
- 系统会在指定时间自动发送通知邮件
- 注意：定时任务每分钟检查一次，所以可能有最多1分钟的延迟

#### 方式三：自动点名（原有功能）
- 点名任务在dateStart和dateEnd日期范围内
- 每天晚上9:00自动创建当天的触发记录
- 触发时间为9:15-9:25之间的随机时间
- 定时任务会自动发送通知

## 邮件配置

确保 `backend/.env` 文件包含以下配置：

```env
EMAIL_USER=roboticlab@qq.com
EMAIL_PASS=ghujiouvebmdcieh
FRONTEND_URL=http://129.226.147.57
```

## 测试步骤

### 测试异议处理邮件
1. 普通用户登录，提交积分异议
2. 管理员登录，处理异议（批准或拒绝）
3. 检查申请人邮箱是否收到通知邮件
4. 如果没收到，检查后台日志是否有邮件发送错误

### 测试立即点名
1. 管理员登录，进入"点名管理"
2. 找到一个点名任务，点击"立即点名"
3. 确认后，检查后台日志是否显示"Attendance notification sent"
4. 目标用户邮箱应该立即收到点名通知

### 测试定时点名
1. 管理员登录，进入"点名管理"
2. 找到一个点名任务，点击"定时点名"
3. 设置一个未来的时间（例如：当前时间+2分钟）
4. 确认后，等待到达指定时间
5. 系统会在指定时间后的1分钟内发送通知邮件

## 常见问题

### 邮件没有发送
1. 检查 .env 文件配置是否正确
2. 检查QQ邮箱授权码是否有效
3. 查看后台日志中的错误信息
4. 确认QQ邮箱SMTP服务是否开启

### 定时点名没有触发
1. 确认后台服务正在运行
2. 检查定时任务是否启动（启动时会显示"Attendance scheduler started"）
3. 定时任务每分钟执行一次，可能有延迟
4. 检查数据库中 daily_attendance_triggers 表是否有对应记录

## 技术实现

### 邮件发送错误处理
- 邮件发送失败不会中断主流程
- 失败时会在控制台输出错误信息
- 如果EMAIL_USER或EMAIL_PASS未配置，会自动跳过邮件发送

### 定时任务
- 每分钟检查是否有需要发送通知的触发记录
- 每分钟检查是否有需要完成（扣分）的点名任务
- 支持手动触发（isManual=1）和自动触发（isManual=0）

### 数据库字段
- `daily_attendance_triggers.isManual`: 0=自动触发，1=手动触发
- `daily_attendance_triggers.notificationSent`: 0=未发送，1=已发送
- `daily_attendance_triggers.completed`: 0=未完成，1=已完成

